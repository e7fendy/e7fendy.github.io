<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="ZR8QGGepc4UG9-cI2U6u00jQi__mQvvAOX0tEOZjcdI">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"e7fendy.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.20.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":280,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="OverviewIn-App Purchase (IAP) is an easy way to do some transactions without knowing the transaction between app and bank. In other words, the transaction will be handled by Apple. Before starting, t">
<meta property="og:type" content="article">
<meta property="og:title" content="[iOS] In-App Purchase">
<meta property="og:url" content="https://e7fendy.github.io/2024/09/20/In-App-Purchase-iOS/index.html">
<meta property="og:site_name" content="Fendy Wu">
<meta property="og:description" content="OverviewIn-App Purchase (IAP) is an easy way to do some transactions without knowing the transaction between app and bank. In other words, the transaction will be handled by Apple. Before starting, t">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://developer.apple.com/in-app-purchase/images/lockup-hero-large_2x.png">
<meta property="og:image" content="https://docs-assets.developer.apple.com/published/44a2bc3082/storeKit_InApp_Purchase_Overview_2x@2x.png">
<meta property="og:image" content="https://bugfender.com/wp-content/uploads/2024/02/INApp_Purchase_-_Page_2-1024x364.webp">
<meta property="og:image" content="https://docs-assets.developer.apple.com/published/5f67d2690b/IAPPG-migration-1@2x.png">
<meta property="og:image" content="https://revenuecat.dreamhosters.com/wp-content/uploads/2022/02/60706bf8c76297fa7775ece4_5e1d78f32cfebf111c51ee1f_Untitled-da6e7b32-7097-44ea-8d08-7fa723260194.png">
<meta property="og:image" content="https://revenuecat.dreamhosters.com/wp-content/uploads/2022/02/60706bf8c76297ad8f75ecf2_5e1d78f4a12b0a5caa85ac2b_Untitled-d292fc14-4319-4a7a-9bd1-996203fb710b.png">
<meta property="og:image" content="https://d2duuy9yo5pldo.cloudfront.net/vizor/b45b5841-c71f-4ce8-a84d-925f22fc4656-t.png">
<meta property="og:image" content="https://cg2010studio.com/wp-content/uploads/2018/05/ios-iap-e9a997e8ad89e799bce7a5a8-iap-verify-receipt.png">
<meta property="og:image" content="https://miro.medium.com/v2/resize:fit:720/format:webp/1*TMDqzfThMD8sDGqyUBum0A.png">
<meta property="og:image" content="https://www.revenuecat.com/docs/assets/images/SCR-20240327-jvrs-6dc3b6a68017f6cfc97178581812a90f.png">
<meta property="og:image" content="https://miro.medium.com/v2/resize:fit:720/format:webp/1*9PI_PMNkvv7pg9yZOPAMuw.png">
<meta property="og:image" content="https://miro.medium.com/v2/resize:fit:720/format:webp/1*a1YY32UQpFrZJ7WI9M41eA.png">
<meta property="og:image" content="https://www.objc.io/images/issue-17/ReceiptStructure@2x_c1f06ab.png">
<meta property="og:image" content="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TFMCdCRoCfxj6cN2wn-Deg.png">
<meta property="og:image" content="https://link-man.net/wp-content/uploads/2020/08/testflighticon.jpg">
<meta property="og:image" content="https://revenuecat.dreamhosters.com/wp-content/uploads/2022/02/60706bf8c7629719a575ed04_5e1d760fd91bf43a74145c1c_Untitled-3b8ea075-1661-4984-9e12-eb5a646884a5.png">
<meta property="og:image" content="https://revenuecat.dreamhosters.com/wp-content/uploads/2022/02/60706bf8c76297158075ec6e_5e1d760f5caa27ed494d5b50_Untitled-9e3f71fa-c78c-479e-912e-088dd5bc13a0.png">
<meta property="article:published_time" content="2024-09-20T07:18:53.000Z">
<meta property="article:modified_time" content="2024-09-19T01:32:40.259Z">
<meta property="article:author" content="Fendy Wu">
<meta property="article:tag" content="iOS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://developer.apple.com/in-app-purchase/images/lockup-hero-large_2x.png">


<link rel="canonical" href="https://e7fendy.github.io/2024/09/20/In-App-Purchase-iOS/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://e7fendy.github.io/2024/09/20/In-App-Purchase-iOS/","path":"2024/09/20/In-App-Purchase-iOS/","title":"[iOS] In-App Purchase"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[iOS] In-App Purchase | Fendy Wu</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MK9FVEWLJV"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-MK9FVEWLJV","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Fendy Wu</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A Developer</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Products"><span class="nav-number">1.1.</span> <span class="nav-text">Products</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Transaction"><span class="nav-number">1.2.</span> <span class="nav-text">Transaction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Payment-Flow"><span class="nav-number">1.2.1.</span> <span class="nav-text">Payment Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Validation-Flow"><span class="nav-number">1.2.2.</span> <span class="nav-text">Validation Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#User-Receipt"><span class="nav-number">1.2.3.</span> <span class="nav-text">User Receipt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Apple-Store-Receipt-File"><span class="nav-number">1.2.4.</span> <span class="nav-text">Apple Store Receipt File</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Testing"><span class="nav-number">1.3.</span> <span class="nav-text">Testing</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Sandbox-Accounts"><span class="nav-number">1.3.1.</span> <span class="nav-text">Sandbox Accounts</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TestFlight"><span class="nav-number">1.3.2.</span> <span class="nav-text">TestFlight</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Environments"><span class="nav-number">1.3.3.</span> <span class="nav-text">Environments</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Purchasing-UI"><span class="nav-number">1.3.4.</span> <span class="nav-text">Purchasing UI</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#App-Store-Server-API-1-0"><span class="nav-number">2.</span> <span class="nav-text">App Store Server API 1.0</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Fendy Wu"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Fendy Wu</p>
  <div class="site-description" itemprop="description">Blog for mobile developers</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/e7fendy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;e7fendy" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/911353/e7fendy" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;911353&#x2F;e7fendy" rel="noopener me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://e7fendy.github.io/2024/09/20/In-App-Purchase-iOS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Fendy Wu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Fendy Wu">
      <meta itemprop="description" content="Blog for mobile developers">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[iOS] In-App Purchase | Fendy Wu">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [iOS] In-App Purchase
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-09-20 15:18:53" itemprop="dateCreated datePublished" datetime="2024-09-20T15:18:53+08:00">2024-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-09-19 09:32:40" itemprop="dateModified" datetime="2024-09-19T09:32:40+08:00">2024-09-19</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2024/09/20/In-App-Purchase-iOS/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/09/20/In-App-Purchase-iOS/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p><img src="https://developer.apple.com/in-app-purchase/images/lockup-hero-large_2x.png" alt="Headline"></p>
<h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>In-App Purchase (IAP) is an easy way to do some transactions without knowing the transaction between app and bank. In other words, the transaction will be handled by Apple. Before starting, there are somethings to be known:</p>
<ul>
<li>The products, like digital items, subscription, feature-enabled, must use iOS In-app purchase.</li>
<li>Apple will charge the transaction.</li>
</ul>
<span id="more"></span>
<p>To implement the IAP, we need to use <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/storekit">StoreKit</a> framework. StoreKit framework includes IAP, App transaction, Messages, Reviews, Recommendations, Ad network attribution.</p>
<p><img src="https://docs-assets.developer.apple.com/published/44a2bc3082/storeKit_InApp_Purchase_Overview_2x@2x.png" alt="Flow"></p>
<h2 id="Products"><a href="#Products" class="headerlink" title="Products"></a>Products</h2><p>Some products must use IAP without excuse, if not, the submission will be refused.</p>
<ul>
<li><strong>Consumable</strong>: Products that can be purchased many times (extra lives, items, etc).</li>
<li><strong>Non Consumable</strong>: Products that is only purchase once and do not expire (advanced features, online courses, etc).</li>
<li><strong>Auto Renew Subscriptions</strong>: Products that provides subscription-based and can automatically renew (Monthly&#x2F;Yearly Subscription, etc).</li>
<li><strong>Non Renewable Subscriptions</strong>: Products that can be subscribed once and there is no automatically renew (3-years Subscription, etc).</li>
</ul>
<p><img src="https://bugfender.com/wp-content/uploads/2024/02/INApp_Purchase_-_Page_2-1024x364.webp" alt="Diagram"></p>
<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><p>Transaction flow consists of three stages:</p>
<ul>
<li>Retrieves product information.</li>
<li>Requests payment.</li>
<li>Delivers products.</li>
</ul>
<p><img src="https://docs-assets.developer.apple.com/published/5f67d2690b/IAPPG-migration-1@2x.png" alt="Flow"></p>
<h3 id="Payment-Flow"><a href="#Payment-Flow" class="headerlink" title="Payment Flow"></a>Payment Flow</h3><p>To do the flow above, I need a server to store my product information and handle the payment process. I’ll use <a target="_blank" rel="noopener" href="https://www.revenuecat.com/">RevenueCat</a> as my transaction server. What the server needs to do is to <strong>validate the payment receive</strong> and <strong>update the user&#x2F;product state</strong>.</p>
<p><img src="https://revenuecat.dreamhosters.com/wp-content/uploads/2022/02/60706bf8c76297fa7775ece4_5e1d78f32cfebf111c51ee1f_Untitled-da6e7b32-7097-44ea-8d08-7fa723260194.png" alt="Flow"></p>
<h3 id="Validation-Flow"><a href="#Validation-Flow" class="headerlink" title="Validation Flow"></a>Validation Flow</h3><p>When user does the transaction, StoreKit will make the payment of the transaction. Meanwhile, StoreKit will also send the transaction to AppStore as a receipt. AppStore will do the receipt verification. To do so, AppStore will send the receipt data to our server for validation using <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/appstoreservernotifications">App Store Server Notifications</a>. Also, our server can store the data to update the state.</p>
<p><img src="https://revenuecat.dreamhosters.com/wp-content/uploads/2022/02/60706bf8c76297ad8f75ecf2_5e1d78f4a12b0a5caa85ac2b_Untitled-d292fc14-4319-4a7a-9bd1-996203fb710b.png" alt="Flow"></p>
<h3 id="User-Receipt"><a href="#User-Receipt" class="headerlink" title="User Receipt"></a>User Receipt</h3><p>On the other hand, the user will receive the receipt that looks like this.</p>
<p><img src="https://d2duuy9yo5pldo.cloudfront.net/vizor/b45b5841-c71f-4ce8-a84d-925f22fc4656-t.png" alt="Receipt"></p>
<h3 id="Apple-Store-Receipt-File"><a href="#Apple-Store-Receipt-File" class="headerlink" title="Apple Store Receipt File"></a>Apple Store Receipt File</h3><p>But, for server, the receive data (what we call “<strong>Apple Store Receipt File</strong>“) will look like this. It is a based64 encoded data.</p>
<p><img src="https://cg2010studio.com/wp-content/uploads/2018/05/ios-iap-e9a997e8ad89e799bce7a5a8-iap-verify-receipt.png" alt="ReceiptData"></p>
<p>The Apple Store Receipt File is based on PKCS #7 container. After parsing and extracting it, there are three parts:</p>
<ul>
<li>Certificates</li>
<li>Signature</li>
<li>Receipt Data (hashed)</li>
</ul>
<p><img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*TMDqzfThMD8sDGqyUBum0A.png" alt="ReceiptData"></p>
<p>Meanwhile, to create the Apple Store Receipt File, we need:</p>
<ul>
<li><strong>App Store Private Key</strong>: Only Apple has this key.</li>
<li><strong>Public Keys (Certificates)</strong>: Setup on AppStore.<br>  <img src="https://www.revenuecat.com/docs/assets/images/SCR-20240327-jvrs-6dc3b6a68017f6cfc97178581812a90f.png" alt="Certificate"></li>
</ul>
<p>When generating Apple Store Receipt File, the receipt data will be hashed, added signature and public keys.</p>
<p><img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*9PI_PMNkvv7pg9yZOPAMuw.png" alt="ReceiptFile"></p>
<p>Therefore, to validate the receipt, we need to check if the receipt data (inside the Apple Store Receipt File) is the same as the receipt data that Apple signed. To do so, we must do the hash matches, as below:</p>
<p><img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*a1YY32UQpFrZJ7WI9M41eA.png" alt="Validate"></p>
<p>After the validation has no problem, I can extract the receipt data. The signed receipt data is an <a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html">ASN.1 container by Apple</a>. It is better to use a parser, see <a target="_blank" rel="noopener" href="https://www.revenuecat.com/blog/engineering/introducing-receiptparser-for-apple-platforms/">ReceiptParser by RevenueCat</a>.</p>
<p><img src="https://www.objc.io/images/issue-17/ReceiptStructure@2x_c1f06ab.png" alt="ASN.1"></p>
<p>After the validation, the receipt info can be parsed correctly. For more, you can check <a target="_blank" rel="noopener" href="https://medium.com/revenuecat-blog/dissecting-an-app-store-receipt-b1e9c5136482">https://medium.com/revenuecat-blog/dissecting-an-app-store-receipt-b1e9c5136482</a> by RevenueCat.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;application_version&#x27;: &#x27;1&#x27;,</span><br><span class="line"> &#x27;bundle_id&#x27;: &#x27;com.jacobeiting.subtester&#x27;,</span><br><span class="line"> &#x27;creation_date&#x27;: &#x27;2017-10-03T00:58:43Z&#x27;,</span><br><span class="line"> &#x27;in_app&#x27;: [&#123;&#x27;cancellation_date&#x27;: &#x27;&#x27;,</span><br><span class="line">             &#x27;expires_date&#x27;: &#x27;2017-10-02T23:16:23Z&#x27;,</span><br><span class="line">             &#x27;original_purchase_date&#x27;: &#x27;2017-10-02T23:08:25Z&#x27;,</span><br><span class="line">             &#x27;original_transaction_id&#x27;: &#x27;1000000339835086&#x27;,</span><br><span class="line">             &#x27;product_id&#x27;: &#x27;onemonth_freetrial&#x27;,</span><br><span class="line">             &#x27;purchase_date&#x27;: &#x27;2017-10-02T23:11:23Z&#x27;,</span><br><span class="line">             &#x27;quantity&#x27;: 1,</span><br><span class="line">             &#x27;transaction_id&#x27;: &#x27;1000000339835183&#x27;,</span><br><span class="line">             &#x27;web_order_line_item_id&#x27;: 1000000036447552&#125;,</span><br><span class="line">            &#123;&#x27;cancellation_date&#x27;: &#x27;&#x27;,</span><br><span class="line">             &#x27;expires_date&#x27;: &#x27;2017-10-02T23:21:23Z&#x27;,</span><br><span class="line">             &#x27;original_purchase_date&#x27;: &#x27;2017-10-02T23:08:25Z&#x27;,</span><br><span class="line">             &#x27;original_transaction_id&#x27;: &#x27;1000000339835086&#x27;,</span><br><span class="line">             &#x27;product_id&#x27;: &#x27;onemonth_freetrial&#x27;,</span><br><span class="line">             &#x27;purchase_date&#x27;: &#x27;2017-10-02T23:16:23Z&#x27;,</span><br><span class="line">             &#x27;quantity&#x27;: 1,</span><br><span class="line">             &#x27;transaction_id&#x27;: &#x27;1000000339835291&#x27;,</span><br><span class="line">             &#x27;web_order_line_item_id&#x27;: 1000000036447572&#125;,</span><br><span class="line">            &#123;&#x27;cancellation_date&#x27;: &#x27;&#x27;,</span><br><span class="line">             &#x27;expires_date&#x27;: &#x27;2017-10-02T23:11:23Z&#x27;,</span><br><span class="line">             &#x27;original_purchase_date&#x27;: &#x27;2017-10-02T23:08:25Z&#x27;,</span><br><span class="line">             &#x27;original_transaction_id&#x27;: &#x27;1000000339835086&#x27;,</span><br><span class="line">             &#x27;product_id&#x27;: &#x27;onemonth_freetrial&#x27;,</span><br><span class="line">             &#x27;purchase_date&#x27;: &#x27;2017-10-02T23:08:23Z&#x27;,</span><br><span class="line">             &#x27;quantity&#x27;: 1,</span><br><span class="line">             &#x27;transaction_id&#x27;: &#x27;1000000339835086&#x27;,</span><br><span class="line">             &#x27;web_order_line_item_id&#x27;: 1000000036447550&#125;],</span><br><span class="line"> &#x27;opaque_value&#x27;: b&#x27;\xdb\x81(\xb1=\xce.&lt;i\xbdkS\xc6\xbe%\x08&#x27;,</span><br><span class="line"> &#x27;original_application_version&#x27;: &#x27;1.0&#x27;,</span><br><span class="line"> &#x27;sha1_hash&#x27;: b&#x27;,\x88\x7f\x9f4\x1b\xc2\xa9W\x18\x1d\x81\x1c%\xbb\x91&quot;*\xe97&#x27;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>Before deploying our IAP, we need to testing our IAP if it works as expected. Before starting, we need to do some preparations, like creating sandbox accounts, uploading app to TestFlight and creating environments for testing, app review and production.</p>
<h3 id="Sandbox-Accounts"><a href="#Sandbox-Accounts" class="headerlink" title="Sandbox Accounts"></a>Sandbox Accounts</h3><p>The accounts that can buy products without any charges.<br><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TFMCdCRoCfxj6cN2wn-Deg.png" alt="Sandbox"></p>
<h3 id="TestFlight"><a href="#TestFlight" class="headerlink" title="TestFlight"></a>TestFlight</h3><p>To test our app with IAP enabled.<br><img src="https://link-man.net/wp-content/uploads/2020/08/testflighticon.jpg" alt="TestFlight"></p>
<h3 id="Environments"><a href="#Environments" class="headerlink" title="Environments"></a>Environments</h3><p>Some environments for testing, app review and production: To use different server environment.<br><img src="https://revenuecat.dreamhosters.com/wp-content/uploads/2022/02/60706bf8c7629719a575ed04_5e1d760fd91bf43a74145c1c_Untitled-3b8ea075-1661-4984-9e12-eb5a646884a5.png" alt="Environments"></p>
<h3 id="Purchasing-UI"><a href="#Purchasing-UI" class="headerlink" title="Purchasing UI"></a>Purchasing UI</h3><p>When purchasing the product by Sandbox accounts (the account must be signed in on your iPhone), the purchasing UI is different with production.<br><img src="https://revenuecat.dreamhosters.com/wp-content/uploads/2022/02/60706bf8c76297158075ec6e_5e1d760f5caa27ed494d5b50_Untitled-9e3f71fa-c78c-479e-912e-088dd5bc13a0.png" alt="Purchasing"></p>
<h1 id="App-Store-Server-API-1-0"><a href="#App-Store-Server-API-1-0" class="headerlink" title="App Store Server API 1.0"></a>App Store Server API 1.0</h1><p>The old APIs (App Store Receipts API) are deprecated. The new one is called App Store Server API. You can request and provide information about your consumers’ in-app purchase. The APIs include:</p>
<ul>
<li>Transactions and auto-renewable subscription status.<ul>
<li>Get the transaction info and history.</li>
</ul>
</li>
<li>Refund information.<ul>
<li>Get the refund history.</li>
</ul>
</li>
<li>App Store Server Notifications history and testing.<ul>
<li>Get the history that App Store Server notified before in past of 180 days.</li>
</ul>
</li>
<li>Subscription renewal date extensions.<ul>
<li>Used to extend the subscription for customer.</li>
</ul>
</li>
<li>Order information lookup.<ul>
<li>Get IAP information based on customer’s order ID.</li>
</ul>
</li>
</ul>
<p>There are some parameters we can use with App Store Server API:</p>
<ul>
<li><strong>transactionId</strong>: The identifier of a transaction that belongs to the customer.</li>
<li><strong>originalTransactionId</strong>: The original transactionId for extended usage.</li>
<li><strong>notificationType</strong>: The type of App Store Server notification, <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/appstoreservernotifications/notificationtype">see more details here</a>.</li>
<li><strong>testNotificationToken</strong>: The unique token for testing.</li>
<li><strong>orderId</strong>: The order ID for IAP that belongs to the customer.</li>
</ul>
<p>To use App Store Server API, we can use the <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/appstoreserverapi/simplifying_your_implementation_by_using_the_app_store_server_library">simplified library</a> that is provided by Apple. Also, there is some <a target="_blank" rel="noopener" href="https://developer.apple.com/documentation/appstoreserverapi/app_store_server_api_changelog">changelogs</a> to be followed.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/iOS/" rel="tag"><i class="fa fa-tag"></i> iOS</a>
          </div>

        
  <div class="social-like a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_dd" target="_blank" rel="noopener" href="https://www.addtoany.com/share"></a>
      <a class="a2a_button_facebook"></a>
      <a class="a2a_button_twitter"></a>
  </div>

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/09/19/Whats-new-with-iOS18/" rel="prev" title="What's new with iOS 18">
                  <i class="fa fa-angle-left"></i> What's new with iOS 18
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Fendy Wu</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>




  <script src="/js/third-party/addtoany.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"e7fendy","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
